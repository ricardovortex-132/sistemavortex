<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VORTEX ‚Äî Panel</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root{
      --sidebar-w:280px;
      --header-h:64px;
      --bg:#f6f8fa;
      --card:#fff;
      --muted:#6b7280;
      --accent:#ff7a3e;
      --accent-2:#ff9b62;
      --soft:#fff7f1;
    }
    *{box-sizing:border-box}
    body,html{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:var(--bg);color:#111}
    .layout{display:flex;height:100vh;overflow:hidden}
    /* SIDEBAR */
    aside.sidebar{
      width:var(--sidebar-w);
      background:linear-gradient(180deg,#fff,#fff);
      box-shadow:2px 0 10px rgba(16,24,40,0.06);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
    }
    .brand{
      display:flex;align-items:center;gap:12px;padding-bottom:6px;border-bottom:1px solid #f0f0f0;margin-bottom:12px;
    }
    .brand .logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    .brand .title{font-weight:800;color:var(--accent);font-size:16px}
    .nav-section{margin-top:8px}
    .section-title{font-size:12px;color:var(--muted);font-weight:700;margin:12px 6px}
    .nav{display:flex;flex-direction:column;gap:6px;padding-bottom:6px}
    .nav button{
      border:none;background:transparent;text-align:left;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700;color:#222;display:flex;gap:10px;align-items:center;font-size:14px;
    }
    .nav button .ic{width:20px;text-align:center;font-size:18px}
    .nav button:hover,.nav button.active{background:var(--soft);color:var(--accent)}
    /* CONTENT */
    .content-wrap{flex:1;display:flex;flex-direction:column}
    header.header{
      height:var(--header-h);display:flex;align-items:center;justify-content:space-between;padding:0 22px;background:transparent;position:sticky;top:0;z-index:5;border-bottom:1px solid #eee;
      backdrop-filter: blur(2px);
    }
    .header-left{display:flex;align-items:center;gap:14px}
    .status{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:6px 12px;border-radius:999px;font-weight:800;font-size:12px}
    .dept-name{background:#fff;padding:6px 12px;border-radius:999px;border:1px solid #eee;font-weight:700;color:#333}
    .header-right{display:flex;align-items:center;gap:12px;position:relative}
    .user-preview{display:flex;align-items:center;gap:10px;cursor:pointer}
    .avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;font-weight:800}
    .user-txt{display:flex;flex-direction:column;align-items:flex-end}
    .user-name{font-weight:800;font-size:14px}
    .user-role{font-size:11px;color:var(--muted);text-transform:uppercase;font-weight:800}
    /* Dropdown user */
    .user-panel{position:absolute;right:0;top:56px;width:300px;background:var(--card);border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.08);padding:16px;display:none;flex-direction:column;gap:8px}
    .user-panel.visible{display:flex}
    .user-panel .initial{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;font-weight:900;margin-bottom:6px}
    .user-panel .meta{font-size:14px}
    .user-panel .meta small{display:block;color:var(--muted);font-size:12px;margin-top:4px}
    .logout{margin-top:10px;background:var(--accent);color:#fff;border:none;padding:10px;border-radius:8px;font-weight:800;cursor:pointer}

    main.main{flex:1;overflow:auto;padding:18px 22px}
    .top-cards{display:flex;gap:14px;align-items:center;margin-bottom:18px;overflow:auto;padding-bottom:8px}
    .emerg-card{min-width:180px;background:var(--card);border-radius:10px;padding:12px 14px;box-shadow:0 6px 18px rgba(15,23,42,0.04);cursor:pointer;display:flex;flex-direction:column;gap:6px}
    .emerg-card .code{font-weight:900;color:var(--accent)}
    .emerg-card .place{font-weight:700;color:#333;font-size:13px}
    /* module content */
    .module{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(15,23,42,0.04)}
    /* Responsive behavior */
    @media(max-width:900px){
      :root{--sidebar-w:220px}
      aside.sidebar{width:var(--sidebar-w);position:fixed;left:-100%;top:0;bottom:0;z-index:40;transition:left .26s}
      aside.sidebar.open{left:0}
      .content-wrap{margin-left:0}
      header.header{left:0;padding:0 12px}
      .burger{display:inline-flex}
    }
    .burger{display:none;cursor:pointer;padding:8px;border-radius:8px}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="sidebar" aria-label="Men√∫ principal">
      <div class="brand">
        <div class="logo">FX</div>
        <div class="title">VORTEX</div>
      </div>

      <div class="nav-section">
        <div class="section-title">Administraci√≥n</div>
        <nav class="nav" id="nav-admin">
          <button data-module="cuentas" class="active"><span class="ic">üë§</span> CUENTAS</button>
          <button data-module="crear-carros"><span class="ic">üöí</span> CREAR CARROS</button>
          <button data-module="crear-cuarteles"><span class="ic">üè†</span> CREAR CUARTELES</button>
          <button data-module="crear-claves"><span class="ic">üîë</span> CREAR CLAVES</button>
          <button data-module="crear-especialidades"><span class="ic">üß∞</span> CREAR ESPECIALIDADES</button>
        </nav>
      </div>

      <div class="nav-section">
        <div class="section-title">Operaciones</div>
        <nav class="nav" id="nav-ops">
          <button data-module="crear-emergencia"><span class="ic">üö®</span> CREAR EMERGENCIA</button>
          <button data-module="emergencias-activas"><span class="ic">üìã</span> EMERGENCIAS ACTIVAS</button>
        </nav>
      </div>

      <div class="nav-section">
        <div class="section-title">Reportes</div>
        <nav class="nav" id="nav-reports">
          <button data-module="informes"><span class="ic">üìä</span> INFORMES</button>
          <button data-module="material-mayor"><span class="ic">üì¶</span> MATERIAL MAYOR</button>
          <button data-module="bitacoras"><span class="ic">üìì</span> BIT√ÅCORAS</button>
        </nav>
      </div>
    </aside>

    <div class="content-wrap">
      <header class="header">
        <div class="header-left">
          <div class="burger" id="burger" title="Abrir men√∫">‚ò∞</div>
          <div class="status">SISTEMA ACTIVO</div>
          <div class="dept-name" id="dept-name">Cuerpo de Bomberos San Bernardo</div>
        </div>

        <div class="header-right">
          <div id="user-preview" class="user-preview" aria-haspopup="true" aria-expanded="false">
            <div class="user-txt">
              <div class="user-name" id="hdr-name">Usuario</div>
              <div class="user-role" id="hdr-role">ROL</div>
            </div>
            <div class="avatar" id="hdr-avatar">A</div>
          </div>

          <div class="user-panel" id="user-panel" role="dialog" aria-hidden="true">
            <div class="initial" id="panel-initial">A</div>
            <div class="meta" id="panel-fullname">Nombre Apellido</div>
            <small id="panel-role">ROL</small>

            <div style="margin-top:6px;border-top:1px solid #f1f1f1;padding-top:10px;display:flex;flex-direction:column;gap:8px">
              <div style="display:flex;gap:8px;align-items:center">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" fill="#ff7a3e"></path></svg>
                <div id="panel-email" style="font-size:13px;color:#333">email@ejemplo.cl</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.11-.21c1.21.49 2.53.76 3.88.76a1 1 0 011 1v3.5a1 1 0 01-1 1C10.07 21.5 2.5 13.93 2.5 4a1 1 0 011-1h3.5a1 1 0 011 1c0 1.35.27 2.67.76 3.88a1 1 0 01-.21 1.11l-2.2 2.2z" fill="#ff7a3e"></path></svg>
                <div id="panel-phone" style="font-size:13px;color:#333">+56 9 1234 5678</div>
              </div>

              <button class="logout" id="btn-logout">Cerrar Sesi√≥n</button>
            </div>
          </div>
        </div>
      </header>

      <main class="main" id="main">
        <div class="top-cards" id="top-cards" aria-live="polite">
          <!-- emergencias cards inserted here -->
        </div>

        <section class="module" id="module">
          <h3 id="module-title" style="margin-top:0;color:var(--accent)">M√≥dulo CUENTAS</h3>
          <div id="module-body">
            <p>Selecciona un m√≥dulo en la izquierda para comenzar. El sistema adapta el men√∫ seg√∫n tu rol.</p>
            <div style="margin-top:12px">
              <button id="open-cuentas" style="background:var(--accent);color:#fff;border:none;padding:10px;border-radius:8px;font-weight:800;cursor:pointer">Administrar CUENTAS</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

<script>
  // --- util ---
  function qs(sel, root=document) { return root.querySelector(sel) }
  function qsa(sel, root=document) { return Array.from(root.querySelectorAll(sel)) }

  // --- session & accounts helpers ---
  function getLogged(){
    try{ return JSON.parse(localStorage.getItem('loggedUser')); } catch(e){ return null; }
  }
  function requireLogin(){
    const u = getLogged();
    if(!u){ window.location.href = 'index.html'; return null; }
    return u;
  }

  // permisos por rol (m√≥dulos = data-module values)
  const permisos = {
    administrador: ['cuentas','crear-carros','crear-cuarteles','crear-claves','crear-especialidades','crear-emergencia','emergencias-activas','informes','material-mayor','bitacoras'],
    operador: ['crear-emergencia','emergencias-activas','informes','material-mayor','bitacoras'],
    bombero: ['emergencias-activas'],
    ayudante: ['emergencias-activas'],
    administrativo: ['cuentas','informes']
  };

  // elementos
  const sidebar = qs('#sidebar');
  const navButtons = qsa('aside.sidebar button');
  const hdrName = qs('#hdr-name'); const hdrRole = qs('#hdr-role'); const hdrAvatar = qs('#hdr-avatar');
  const panel = qs('#user-panel'); const userPreview = qs('#user-preview');
  const panelEmail = qs('#panel-email'); const panelPhone = qs('#panel-phone');
  const panelFullname = qs('#panel-fullname'); const panelRole = qs('#panel-role'); const panelInitial = qs('#panel-initial');
  const deptEl = qs('#dept-name');
  const topCards = qs('#top-cards');
  const moduleTitle = qs('#module-title'); const moduleBody = qs('#module-body');
  const burger = qs('#burger');

  // mock emergencias (puedes reemplazar por datos reales)
  const emergenciasActivas = [
    { id:'6-14', place:'San Jos√©', desc:'Incendio declarado', color:'#ffe9dc' },
    { id:'10-3-1', place:'Av. Las Acacias', desc:'Choque m√∫ltiple', color:'#dfe9ff' },
    { id:'10-2-2', place:'Presidente Jorge', desc:'Rescate', color:'#e6ffe8' }
  ];

  // init
  (function init(){
    const user = requireLogin();
    if(!user) return;
    // header user
    hdrName.textContent = user.name ? user.name.split(' ')[0] : user.username;
    hdrRole.textContent = (user.role || '').toUpperCase();
    hdrAvatar.textContent = (user.name || user.username || 'U').slice(0,1).toUpperCase();

    panelFullname.textContent = user.name || user.username;
    panelRole.textContent = (user.role || '').toUpperCase();
    panelInitial.textContent = hdrAvatar.textContent;
    panelEmail.textContent = user.email || '‚Äî';
    panelPhone.textContent = user.phone || '‚Äî';
    deptEl.textContent = user.department || 'Cuerpo de Bomberos San Bernardo';

    // render emergencias
    renderEmergencias();

    // enforce permissions
    enforcePermissions(user.role);

    // attach nav handlers
    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        navButtons.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        loadModule(btn.getAttribute('data-module'), btn.textContent.trim());
        // close sidebar on mobile
        if(window.innerWidth <= 900) sidebar.classList.remove('open');
      });
    });

    // user panel toggle
    userPreview.addEventListener('click', () => {
      const open = panel.classList.toggle('visible');
      userPreview.setAttribute('aria-expanded', open ? 'true' : 'false');
    });

    // click outside to close
    document.addEventListener('click', (e) => {
      if(!qs('#user-panel').contains(e.target) && !qs('#user-preview').contains(e.target)){
        panel.classList.remove('visible');
        userPreview.setAttribute('aria-expanded', 'false');
      }
    });

    // logout
    qs('#btn-logout').addEventListener('click', () => {
      localStorage.removeItem('loggedUser');
      // optionally keep accounts; just remove session
      window.location.href = 'index.html';
    });

    // open cuentas button
    qs('#open-cuentas').addEventListener('click', () => {
      // simulate clicking button for cuentas
      const btn = qsa('aside.sidebar button').find(b=>b.dataset.module==='cuentas');
      if(btn) btn.click();
    });

    // burger for mobile
    if(burger) burger.addEventListener('click', ()=> sidebar.classList.toggle('open'));

    // keyboard accessibility for emerg cards
    topCards.addEventListener('keydown', (e)=>{
      if(e.target && e.target.classList && e.target.classList.contains('emerg-card') && (e.key==='Enter' || e.key===' ')){
        e.preventDefault(); e.target.click();
      }
    });
  })();

  // --- functions ---
  function enforcePermissions(role){
    const rolKey = (role||'').toLowerCase();
    const allowed = permisos[rolKey] || [];
    // If administrador -> show all
    qsa('aside.sidebar button').forEach(btn=>{
      const mod = btn.getAttribute('data-module');
      if(rolKey === 'administrador' || allowed.includes(mod)){
        btn.style.display = '';
      } else {
        btn.style.display = 'none';
      }
    });
    // ensure at least first visible is active
    const firstVisible = qsa('aside.sidebar button').find(b=>b.style.display!=='none');
    if(firstVisible){
      qsa('aside.sidebar button').forEach(b=>b.classList.remove('active'));
      firstVisible.classList.add('active');
      loadModule(firstVisible.dataset.module, firstVisible.textContent.trim());
    } else {
      moduleTitle.textContent = 'Sin permisos';
      moduleBody.innerHTML = '<p>No tienes permisos asignados para ver m√≥dulos.</p>';
    }
  }

  function loadModule(moduleKey, label){
    // simple routing for modules (expand later)
    moduleTitle.textContent = 'M√≥dulo ' + label;
    if(moduleKey === 'emergencias-activas'){
      // show list of emergencias
      moduleBody.innerHTML = `<p>Emergencias activas:</p><ul>${emergenciasActivas.map(e=>`<li><strong>${e.id}</strong> ‚Äî ${e.place} ‚Äî ${e.desc}</li>`).join('')}</ul>`;
    } else if(moduleKey === 'cuentas'){
      // quick embedded accounts manager (basic)
      moduleBody.innerHTML = renderAccountsManagerHtml();
      attachAccountsManagerHandlers();
    } else {
      moduleBody.innerHTML = `<p>Gesti√≥n de <strong>${label}</strong> (en construcci√≥n).</p>`;
    }
  }

  function renderEmergencias(){
    topCards.innerHTML = '';
    emergenciasActivas.forEach(e=>{
      const d = document.createElement('div');
      d.className = 'emerg-card';
      d.tabIndex = 0;
      d.innerHTML = `<div class="code">${e.id}</div><div class="place">${e.place}</div><div style="font-size:13px;color:${'#666'}">${e.desc}</div>`;
      d.addEventListener('click', ()=> {
        // abrir m√≥dulo emergencias activas
        const btn = qsa('aside.sidebar button').find(b=>b.dataset.module==='emergencias-activas');
        if(btn) btn.click();
      });
      topCards.appendChild(d);
    });
  }

  // --- Basic accounts manager html & handlers (so you can create users now) ---
  function renderAccountsManagerHtml(){
    const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
    return `
      <div style="display:flex;gap:16px;flex-wrap:wrap">
        <div style="flex:1;min-width:280px">
          <h4>Crear / Editar usuario</h4>
          <form id="frm-account" style="display:flex;flex-direction:column;gap:8px">
            <input type="hidden" id="acc-id" />
            <label>Nombre completo</label><input id="acc-name" required />
            <label>C√≥digo de acceso (username)</label><input id="acc-username" required />
            <label>Contrase√±a</label><input id="acc-password" type="password" />
            <label>Email</label><input id="acc-email" />
            <label>Tel√©fono</label><input id="acc-phone" />
            <label>Rol</label>
            <select id="acc-role">
              <option value="administrador">Administrador</option>
              <option value="operador">Operador</option>
              <option value="bombero">Bombero</option>
              <option value="ayudante">Ayudante</option>
              <option value="administrativo">Administrativo</option>
            </select>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button type="submit" style="background:var(--accent);color:#fff;border:none;padding:8px;border-radius:8px;font-weight:800">Guardar</button>
              <button type="button" id="acc-cancel" style="background:#f3f4f6;border:none;padding:8px;border-radius:8px;font-weight:800">Limpiar</button>
            </div>
          </form>
        </div>

        <div style="flex:1;min-width:320px">
          <h4>Usuarios</h4>
          <div style="max-height:320px;overflow:auto">
            <table style="width:100%;border-collapse:collapse">
              <thead style="font-weight:800;color:var(--muted);font-size:13px">
                <tr><th style="text-align:left;padding:6px 8px">Usuario</th><th style="padding:6px 8px">Rol</th><th style="padding:6px 8px">Acciones</th></tr>
              </thead>
              <tbody id="accounts-tbody">
                ${accounts.map(a=>`<tr data-id="${a.id}"><td style="padding:8px">${a.name} <small style="color:${'#888'}">(${a.username})</small></td><td style="padding:8px;text-transform:capitalize">${a.role}</td><td style="padding:8px"><button data-action="edit" data-id="${a.id}" style="margin-right:6px">Editar</button><button data-action="del" data-id="${a.id}">Borrar</button></td></tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  }

  function attachAccountsManagerHandlers(){
    const frm = qs('#frm-account');
    const tbody = qs('#accounts-tbody');
    const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');

    // submit -> create/update
    frm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = qs('#acc-id').value;
      const name = qs('#acc-name').value.trim();
      const username = qs('#acc-username').value.trim();
      const password = qs('#acc-password').value;
      const email = qs('#acc-email').value.trim();
      const phone = qs('#acc-phone').value.trim();
      const role = qs('#acc-role').value;

      let list = JSON.parse(localStorage.getItem('accounts') || '[]');

      // validations
      if(!name || !username){
        alert('Nombre y c√≥digo de acceso son obligatorios.');
        return;
      }
      // check duplicate username (except editing same)
      const dup = list.find(a => a.username.toLowerCase() === username.toLowerCase() && a.id !== id);
      if(dup){ alert('C√≥digo de acceso ya existe.'); return; }

      if(id){
        // update
        list = list.map(a => {
          if(a.id === id){
            return {...a, name, username, email, phone, role, password: password?password:a.password};
          }
          return a;
        });
      } else {
        // create
        list.push({
          id: 'id-'+Math.random().toString(36).slice(2,9),
          name, username, password: password||'1234', email, phone, role
        });
      }
      localStorage.setItem('accounts', JSON.stringify(list));
      // refresh module area
      loadModule('cuentas','CUENTAS');
    });

    // cancel
    qs('#acc-cancel').addEventListener('click', ()=>{
      qs('#acc-id').value=''; qs('#acc-name').value=''; qs('#acc-username').value=''; qs('#acc-password').value=''; qs('#acc-email').value=''; qs('#acc-phone').value=''; qs('#acc-role').value='operador';
    });

    // actions edit/delete
    tbody.querySelectorAll('button').forEach(btn=>{
      const id = btn.dataset.id;
      if(btn.dataset.action === 'edit'){
        btn.addEventListener('click', ()=>{
          const list = JSON.parse(localStorage.getItem('accounts')||'[]');
          const acc = list.find(x=>x.id===id);
          if(!acc) return;
          qs('#acc-id').value = acc.id;
          qs('#acc-name').value = acc.name;
          qs('#acc-username').value = acc.username;
          qs('#acc-password').value = ''; // do not fill existing password
          qs('#acc-email').value = acc.email || '';
          qs('#acc-phone').value = acc.phone || '';
          qs('#acc-role').value = acc.role || 'operador';
          window.scrollTo({top:0,behavior:'smooth'});
        });
      } else if(btn.dataset.action === 'del'){
        btn.addEventListener('click', ()=>{
          if(!confirm('Eliminar usuario?')) return;
          let list = JSON.parse(localStorage.getItem('accounts')||'[]');
          const toRemove = list.find(a=>a.id===id);
          if(toRemove && (toRemove.username==='admin')){ alert('No puedes borrar la cuenta admin por defecto.'); return; }
          list = list.filter(a=>a.id!==id);
          localStorage.setItem('accounts', JSON.stringify(list));
          loadModule('cuentas','CUENTAS');
        });
      }
    });
  }

</script>
</body>
</html>
