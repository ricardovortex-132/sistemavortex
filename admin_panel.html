<script>
  function getAccounts(){ return JSON.parse(localStorage.getItem('accounts') || '[]'); }
  function saveAccounts(a){ localStorage.setItem('accounts', JSON.stringify(a)); }

  // Asegurar cuentas por defecto (puedes omitir si ya lo tienes)
  function ensureDefaultAccounts(){
    let accounts = getAccounts();
    if(!accounts.some(a=>a.user==='admin')){
      accounts.push({user:'admin', pass:'1234', nombre:'Super Admin', role:'superadmin', assignedDept:null});
      saveAccounts(accounts);
    }
  }
  ensureDefaultAccounts();

  const btnLogin = document.getElementById('btn-login');
  const errorMsg = document.getElementById('error-msg');

  btnLogin.addEventListener('click', () => {
    errorMsg.textContent = '';
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value.trim();
    const dept = document.getElementById('dept-select').value;

    if(!dept){ errorMsg.textContent = 'Selecciona el cuerpo de bomberos'; return; }
    if(!user || !pass){ errorMsg.textContent = 'Usuario y contraseÃ±a requeridos'; return; }

    const accounts = getAccounts();
    const account = accounts.find(a => a.user === user && a.pass === pass);

    if(!account){ errorMsg.textContent = 'Credenciales incorrectas'; return; }

    if(account.role !== 'superadmin' && account.assignedDept && account.assignedDept !== dept){
      errorMsg.textContent = 'Este usuario no pertenece al cuerpo seleccionado';
      return;
    }

    const session = {
      user: account.user,
      nombre: account.nombre || account.user,
      role: account.role || 'operator',
      dept: dept,
      loggedAt: new Date().toISOString()
    };
    localStorage.setItem('vortex_session', JSON.stringify(session));

    window.location.href = 'admin_panel.html';
  });
</script>
