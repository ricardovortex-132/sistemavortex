<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VORTEX - Login</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

    :root{
      --orange-1: #ff6a00;
      --orange-2: #ff8a33;
      --deep-blue: #0f2a52;
      --soft-blue: #2b6fb3;
      --bg: #ffff;
      --card: rgba(255,255,255,0.98);
      --muted: #6b7280;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;}
    html,body{height:100%;background:var(--bg);color:#222;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}

    /* Animated aurora background (orange + blue flowing blobs) */
    .aurora { position:fixed; inset:0; z-index:0; overflow:hidden; background: linear-gradient(180deg,#fffaf8 0%, #fbfcff 100%); }
    .blob { position:absolute; filter: blur(90px) saturate(120%); opacity:0.9; transform-origin:center; animation: float 12s ease-in-out infinite alternate; }
    .blob.one{ width:1000px; height:1000px; left:-18%; top:-30%; background: radial-gradient(circle at 30% 30%, rgba(255,140,50,0.20), rgba(255,106,0,0.16) 30%, transparent 60%); animation-duration: 16s; transform: rotate(5deg); }
    .blob.two{ width:900px; height:900px; right:-12%; top:-6%; background: radial-gradient(circle at 65% 65%, rgba(30,100,200,0.12), rgba(40,140,220,0.10) 40%, transparent 60%); animation-duration: 12s; transform: rotate(-6deg); }
    .blob.three{ width:700px; height:700px; left:4%; bottom:-30%; background: radial-gradient(circle at 40% 60%, rgba(255,120,50,0.12), rgba(255,80,20,0.06) 40%, transparent 70%); animation-duration: 20s; transform: rotate(3deg); }
    @keyframes float { 0% { transform: translateY(0) scale(1) rotate(0deg);} 100% { transform: translateY(-30px) scale(1.05) rotate(6deg);} }

    /* Layout */
    .wrap { position:relative; z-index:2; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px; }
    .card { width:460px; max-width:96vw; background:var(--card); border-radius:16px; box-shadow: 0 12px 40px rgba(15,42,82,0.08); padding:32px; border:1px solid rgba(20,20,20,0.04); text-align:center; }

    /* Logo */
    .logo { display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:10px; }
    .logo img { width:120px; height:auto; display:block; border-radius:12px; box-shadow: 0 10px 30px rgba(255,106,0,0.08); }
    .title { font-weight:800; font-size:28px; letter-spacing:1px; margin-top:4px; background: linear-gradient(90deg,var(--orange-1),var(--orange-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .subtitle { font-size:13px; color:var(--muted); margin-top:2px; }

    form { margin-top:18px; display:grid; gap:12px; align-items:center; }
    select, input { width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(15,42,82,0.06); font-size:15px; color:#111; outline:none; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,252,0.98)); }
    select:focus, input:focus { box-shadow:0 8px 20px rgba(39,108,176,0.06); border-color: rgba(255,106,0,0.16); }

    button.primary { margin-top:6px; padding:12px 14px; border-radius:12px; border:none; cursor:pointer; background: linear-gradient(90deg,var(--orange-1),var(--orange-2)); color:white; font-weight:700; font-size:16px; box-shadow:0 10px 30px rgba(255,106,0,0.14); }
    .muted-link { color:var(--deep-blue); text-decoration: none; font-weight:600; cursor:pointer; }
    .error { color:#cc3300; font-size:14px; min-height:20px; text-align:left; }

    /* Welcome overlay with vortex */
    .overlay { position:fixed; inset:0; z-index:8; display:flex; align-items:center; justify-content:center; background: radial-gradient(circle at center, rgba(10,25,55,0.5), rgba(10,25,55,0.75)); opacity:0; pointer-events:none; transition:opacity .25s ease; }
    .overlay.show { opacity:1; pointer-events:auto; }
    .welcome-box { background: rgba(255,255,255,0.04); color:white; padding:28px 34px; border-radius:14px; text-align:center; backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,0.06); display:flex; flex-direction:column; gap:12px; align-items:center; }
    .welcome-title { font-weight:900; font-size:26px; color:#fff; letter-spacing:2px; display:flex; align-items:center; gap:12px; justify-content:center; }
    .vortex { width:46px; height:46px; border-radius:50%; position:relative; overflow:hidden; display:inline-block; vertical-align:middle; }
    .vortex::before { content:""; position:absolute; inset:0; border-radius:50%; background: conic-gradient(from 0deg, rgba(255,160,90,0.95), rgba(255,110,45,0.95) 40%, rgba(255,200,120,0.85) 70%, rgba(255,140,60,0.9)); animation: spin 1.1s linear infinite; transform-origin:center; box-shadow:0 8px 30px rgba(255,110,45,0.14); }
    @keyframes spin { to { transform: rotate(360deg); } }
    .welcome-sub { color:#fff; opacity:0.95; font-size:15px; max-width:760px; }

    /* Small logged widget */
    .logged-widget { position:fixed; top:18px; right:18px; z-index:9; display:none; }
    .small-card { width:280px; padding:12px 14px; border-radius:12px; box-shadow: 0 10px 30px rgba(15,42,82,0.08); background:var(--card); border:1px solid rgba(20,20,20,0.04); }
    .small-card img { width:44px; height:44px; border-radius:8px; }
    .small-row { display:flex; gap:10px; align-items:center; }

    .logout { padding:8px 12px; border-radius:10px; border:2px solid rgba(255,255,255,0.12); color:#111; background:transparent; cursor:pointer; font-weight:700; }

    /* Modals */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items:center; justify-content:center; z-index:12; }
    .modal.show { display:flex; }
    .modal-content { background:white; border-radius:12px; padding:20px 18px; width:360px; max-width:92vw; text-align:left; box-shadow: 0 12px 40px rgba(15,42,82,0.08); }
    .modal-content h3 { margin-bottom:12px; color:var(--deep-blue); }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

    @media(max-width:520px){ .card { padding:20px; } .title { font-size:22px; } .welcome-title { font-size:20px; } .vortex { width:40px; height:40px; } .modal-content { width:90vw; } }
  </style>
</head>
<body>
  <div class="aurora" aria-hidden="true">
    <div class="blob one"></div>
    <div class="blob two"></div>
    <div class="blob three"></div>
  </div>

  <div class="wrap">
    <div class="card" id="card-login" role="main">
      <div class="logo" aria-hidden="false">
        <img src="icon-vortex.png" alt="VORTEX logo" />
        <div class="title">VORTEX</div>
        <div class="subtitle">Sistema automatizado de respuesta en tiempo real</div>
      </div>

      <form id="login-form" autocomplete="on" onsubmit="return false;">
        <select id="dept-select" required aria-label="Seleccionar cuerpo de bomberos">
          <option value="" disabled selected>Seleccione cuerpo de bomberos</option>
          <option>Bomberos Paine</option>
          <option>Buin</option>
          <option>San Bernardo</option>
          <option>Metropolitano Sur</option>
          <option>La Granja</option>
          <option>Maipu</option>
          <option>Santiago</option>
          <option>Ñuñoa</option>
          <option>Conchali-Huechuraba</option>
          <option>Colina-Lampa</option>
        </select>

        <input id="username" type="text" placeholder="Usuario" required autocomplete="username" />
        <input id="password" type="password" placeholder="Contraseña" required autocomplete="current-password" />
        <div class="error" id="error-msg" aria-live="polite"></div>
        <button class="primary" id="btn-login" type="button">Iniciar sesión</button>
      </form>

      <div style="margin-top:12px; font-size:14px; text-align:center;">
        <a id="forgot-link" class="muted-link">¿Olvidaste tu clave?</a>
      </div>
    </div>
  </div>

  <!-- Welcome overlay -->
  <div class="overlay" id="overlay-welcome" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="welcome-box" role="document">
      <div class="welcome-title">
        <span class="vortex" aria-hidden="true"></span>
        <span>BIENVENIDOS A VORTEX</span>
      </div>
      <div class="welcome-sub" id="welcome-sub">Redirigiendo...</div>
    </div>
  </div>

  <!-- Small logged widget -->
  <div class="logged-widget" id="logged-widget" aria-live="polite">
    <div class="small-card">
      <div class="small-row">
        <img src="icon-vortex.png" alt="" />
        <div style="flex:1">
          <div id="logged-name" style="font-weight:800"></div>
          <div id="logged-dept" style="color:var(--muted); font-size:13px"></div>
        </div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
        <button id="btn-change-pass" class="logout" style="background:#fffbf7;border:2px solid var(--orange-1); color:var(--orange-1)">Cambiar clave</button>
        <button id="btn-logout" class="logout">Cerrar sesión</button>
      </div>
    </div>
  </div>

  <!-- Forgot password modal (simulado por ahora) -->
  <div class="modal" id="modal-forgot">
    <div class="modal-content">
      <h3>Recuperar contraseña</h3>
      <p>Ingresa tu nombre de usuario (se enviará un correo simulado):</p>
      <input id="forgot-username" placeholder="Usuario" />
      <div class="modal-actions">
        <button id="btn-send-recovery" class="primary" style="background:linear-gradient(90deg,var(--orange-1),var(--orange-2));">Enviar correo</button>
        <button id="btn-close-forgot" style="background:#eee;padding:10px;border-radius:8px;border:1px solid #ddd;">Cancelar</button>
      </div>
      <p id="forgot-result" style="margin-top:10px;color:#333;"></p>
    </div>
  </div>

  <!-- Change password modal -->
  <div class="modal" id="modal-change">
    <div class="modal-content">
      <h3>Cambiar contraseña</h3>
      <p>Usuario: <strong id="cp-username"></strong></p>
      <input id="cp-old" type="password" placeholder="Contraseña actual" />
      <input id="cp-new" type="password" placeholder="Nueva contraseña" style="margin-top:8px;" />
      <div class="modal-actions">
        <button id="btn-change-save" class="primary">Guardar</button>
        <button id="btn-close-change" style="background:#eee;padding:10px;border-radius:8px;border:1px solid #ddd;">Cancelar</button>
      </div>
      <p id="cp-result" style="margin-top:10px;color:#333;"></p>
    </div>
  </div>

  <script>
    /* ==== Datos por defecto de cuentas ====
       Cuentas creadas automáticamente (usuario : contraseña):
       - admin : 1234           (superadmin - puede entrar en cualquier CB)
       - paine : paine          (admin - assignedDept: Bomberos Paine)
       - buin : buin            (admin - assignedDept: Buin)
       - sanbernardo : sanbernardo (admin - assignedDept: San Bernardo)
       - metropolitano_sur : metropolitano_sur (admin - assignedDept: Metropolitano Sur)
       - lagranja : lagranja
       - maipu : maipu
       - santiago : santiago
       - nunoa : nunoa
       - conchali_huechuraba : conchali
       - colina_lampa : colina
       Puedes cambiar estas claves luego desde el módulo CUENTAS.
    ==== */

    function getAccounts(){ return JSON.parse(localStorage.getItem('accounts') || '[]'); }
    function saveAccounts(a){ localStorage.setItem('accounts', JSON.stringify(a)); }

    function ensureDefaultAccounts(){
      let accounts = getAccounts();

      // Mapea: username, pass, nombre, role, assignedDept (null = any)
      const defaults = [
        { user:'admin', pass:'1234', nombre:'Super Administrador', role:'superadmin', assignedDept: null },

        { user:'paine', pass:'paine', nombre:'Admin Paine', role:'admin', assignedDept: 'Bomberos Paine' },
        { user:'buin', pass:'buin', nombre:'Admin Buin', role:'admin', assignedDept: 'Buin' },
        { user:'sanbernardo', pass:'sanbernardo', nombre:'Admin San Bernardo', role:'admin', assignedDept: 'San Bernardo' },
        { user:'metropolitano_sur', pass:'metropolitano_sur', nombre:'Admin Metropolitano Sur', role:'admin', assignedDept: 'Metropolitano Sur' },
        { user:'lagranja', pass:'lagranja', nombre:'Admin La Granja', role:'admin', assignedDept: 'La Granja' },
        { user:'maipu', pass:'maipu', nombre:'Admin Maipu', role:'admin', assignedDept: 'Maipu' },
        { user:'santiago', pass:'santiago', nombre:'Admin Santiago', role:'admin', assignedDept: 'Santiago' },
        { user:'nunoa', pass:'nunoa', nombre:'Admin Ñuñoa', role:'admin', assignedDept: 'Ñuñoa' },
        { user:'conchali_huechuraba', pass:'conchali', nombre:'Admin Conchali-Huechuraba', role:'admin', assignedDept: 'Conchali-Huechuraba' },
        { user:'colina_lampa', pass:'colina', nombre:'Admin Colina-Lampa', role:'admin', assignedDept: 'Colina-Lampa' },
      ];

      // Añadir defaults si no existen
      defaults.forEach(d => {
        if(!accounts.some(a => a.user === d.user)){
          accounts.push(d);
        }
      });
      saveAccounts(accounts);
      console.log('Cuentas actuales:', accounts);
    }

    ensureDefaultAccounts();

    // Elements
    const btnLogin = document.getElementById('btn-login');
    const errorMsg = document.getElementById('error-msg');
    const overlay = document.getElementById('overlay-welcome');
    const welcomeSub = document.getElementById('welcome-sub');
    const loggedWidget = document.getElementById('logged-widget');
    const loggedName = document.getElementById('logged-name');
    const loggedDept = document.getElementById('logged-dept');
    const btnLogout = document.getElementById('btn-logout');
    const btnChangePass = document.getElementById('btn-change-pass');

    const modalForgot = document.getElementById('modal-forgot');
    const forgotLink = document.getElementById('forgot-link');
    const btnCloseForgot = document.getElementById('btn-close-forgot');
    const btnSendRecovery = document.getElementById('btn-send-recovery');
    const forgotResult = document.getElementById('forgot-result');

    const modalChange = document.getElementById('modal-change');
    const cpUsername = document.getElementById('cp-username');
    const cpOld = document.getElementById('cp-old');
    const cpNew = document.getElementById('cp-new');
    const btnCloseChange = document.getElementById('btn-close-change');
    const btnChangeSave = document.getElementById('btn-change-save');
    const cpResult = document.getElementById('cp-result');

    // Login
    btnLogin.addEventListener('click', () => {
      errorMsg.textContent = '';
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      const dept = document.getElementById('dept-select').value;

      if(!dept){ errorMsg.textContent = 'Selecciona el cuerpo de bomberos'; return; }
      if(!user || !pass){ errorMsg.textContent = 'Usuario y contraseña requeridos'; return; }

      const accounts = getAccounts();
      const account = accounts.find(a => a.user === user && a.pass === pass);

      if(!account){ errorMsg.textContent = 'Credenciales incorrectas'; return; }

      // Si no es superadmin y tiene assignedDept, obligar a coincidir
      if(account.role !== 'superadmin' && account.assignedDept && account.assignedDept !== dept){
        errorMsg.textContent = 'Este usuario no pertenece al cuerpo seleccionado';
        return;
      }

      // Guardar sesión (persistente)
      const session = { user: account.user, nombre: account.nombre || account.user, role: account.role || 'operator', dept: dept, loggedAt: new Date().toISOString() };
      localStorage.setItem('vortex_session', JSON.stringify(session));

      showWelcome(session);
    });

    function showWelcome(session){
      welcomeSub.textContent = `Has entrado como ${session.nombre} — ${session.dept}`;
      overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
      setTimeout(() => {
        overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true');
        // mostrar widget local
        showLoggedWidget(session);
        // Guardar sesi n tambi n en el formato que usa admin_panel (loggedUser) para compatibilidad
        const loggedUser = {
          username: session.user,
          name: session.nombre || session.user,
          role: (session.role === 'superadmin' || session.role === 'admin') ? 'administrador' : (session.role || 'operador'),
          email: session.email || '',
          phone: session.phone || '',
          department: session.dept
        };
        localStorage.setItem('loggedUser', JSON.stringify(loggedUser));
        // redirigir al panel de administraci n
        window.location.href = 'admin_panel.html';
      }, 900);
    }

    function showLoggedWidget(session){
      loggedName.textContent = session.nombre;
      loggedDept.textContent = session.dept + (session.role ? ' — ' + session.role.toUpperCase() : '');
      document.getElementById('logged-widget').style.display = 'block';
      document.querySelector('.wrap').style.filter = 'blur(0.6px) brightness(0.98)';
    }

    // Mantener sesión abierta si existe
    (function restoreSession(){
      const s = JSON.parse(localStorage.getItem('vortex_session') || 'null');
      if(s){ showLoggedWidget(s); }
    })();

    // Logout
    btnLogout.addEventListener('click', () => {
      if(confirm('¿Cerrar sesión?')) {
        localStorage.removeItem('vortex_session');
        document.getElementById('logged-widget').style.display = 'none';
        document.querySelector('.wrap').style.filter = 'none';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('dept-select').selectedIndex = 0;
      }
    });

    // Forgot password (simulado): solicita usuario -> "envía correo"
    forgotLink.addEventListener('click', (e) => { e.preventDefault(); forgotResult.textContent=''; document.getElementById('forgot-username').value=''; modalForgot.classList.add('show'); });
    btnCloseForgot.addEventListener('click', () => { modalForgot.classList.remove('show'); });
    btnSendRecovery.addEventListener('click', () => {
      const u = document.getElementById('forgot-username').value.trim();
      if(!u){ forgotResult.textContent = 'Ingresa un usuario válido'; return; }
      const accounts = getAccounts();
      const acc = accounts.find(a => a.user === u);
      if(!acc){ forgotResult.textContent = 'Usuario no encontrado'; return; }
      // Simular envío
      forgotResult.textContent = `Correo de recuperación enviado (simulado) para el usuario ${u}. Sigue las instrucciones recibidas.`;
      console.log(`[SIMULADO] Enviar correo de recuperación a ${u} (implementa backend para correo real).`);
    });

    // Cambiar contraseña (desde modal), usuario actual desde session
    btnChangePass.addEventListener('click', () => {
      const s = JSON.parse(localStorage.getItem('vortex_session') || 'null');
      if(!s){ alert('No hay sesión activa'); return; }
      cpUsername.textContent = s.user;
      cpOld.value = ''; cpNew.value = ''; cpResult.textContent = '';
      modalChange.classList.add('show');
    });
    btnCloseChange.addEventListener('click', () => { modalChange.classList.remove('show'); });

    btnChangeSave.addEventListener('click', () => {
      const s = JSON.parse(localStorage.getItem('vortex_session') || 'null');
      if(!s){ cpResult.textContent = 'No hay sesión activa'; return; }
      const oldp = cpOld.value.trim();
      const newp = cpNew.value.trim();
      if(!oldp || !newp){ cpResult.textContent = 'Completa ambos campos'; return; }
      // Verificar contraseña actual
      const accounts = getAccounts();
      const accIndex = accounts.findIndex(a => a.user === s.user);
      if(accIndex === -1){ cpResult.textContent = 'Cuenta no encontrada'; return; }
      if(accounts[accIndex].pass !== oldp){ cpResult.textContent = 'Contraseña actual incorrecta'; return; }
      accounts[accIndex].pass = newp;
      saveAccounts(accounts);
      cpResult.textContent = 'Contraseña actualizada correctamente';
      console.log(`Usuario ${s.user} cambió su contraseña`);
      setTimeout(()=>{ modalChange.classList.remove('show'); }, 900);
    });

    // Enter key triggers login
    document.getElementById('password').addEventListener('keydown', (ev) => { if(ev.key === 'Enter'){ ev.preventDefault(); btnLogin.click(); } });
    document.getElementById('login-form').addEventListener('submit', (ev) => ev.preventDefault());
  </script>
</body>
</html>
